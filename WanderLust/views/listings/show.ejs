<%- layout("./layouts/boilerplate.ejs") %>
<div class="row mt-3">
  <div class="col text-center">
    <h3><%= listing.title %></h3>
  </div>
</div>

<div class="row justify-content-center mt-3">
  <div class="card col-6 offset-1 showw-card listing-card">
    <img src="<%= listing.image %>" class="card-img-top show-img">
    <div class="card-body">
      <p class="card-text">
        
      </p>
    </div>
  </div>
</div>

<div class="row justify-content-center mt-3">
  <div class="col-8">
    <ul>
      <li><%= listing.description %></li>
      <li>&#8377;<%= listing.price.toLocaleString("en-IN") %></li>
      <li><%= listing.location %></li>
      <li><%= listing.country %></li>
    </ul>
    <br>

    <% if (currentUser && listing.owner && String(listing.owner._id) === String(currentUser._id)) { %>
      <div class="d-flex gap-2 mt-3">
        <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark">
          Edit This Listing
        </a>
        <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
          <button class="btn btn-danger">Delete This Listing</button>
        </form>
      </div>
    <% } %>
  </div>
</div>

<div class="row justify-content-center mt-4">
  <div class="col-8">
    <hr>
    <h4>Leave A Review</h4>
    <% if (typeof error !== 'undefined' && error && error.length) { %>
      <div class="alert alert-danger"><%= error %></div>
    <% } %>
    <% if (currentUser) { %>
      <form action="/listings/<%= listing._id %>/review" method="POST" id="reviewForm">
        <div class="mb-3 mt-3">
          <label class="d-block mb-1">Rating <span class="text-danger">*</span></label>
          <div class="star-rating" id="starRating">
            <input type="radio" id="star-1" name="review[rating]" value="1">
            <label for="star-1" data-value="1"><i class="fa-solid fa-star"></i></label>
            <input type="radio" id="star-2" name="review[rating]" value="2">
            <label for="star-2" data-value="2"><i class="fa-solid fa-star"></i></label>
            <input type="radio" id="star-3" name="review[rating]" value="3" checked>
            <label for="star-3" data-value="3" class="active"><i class="fa-solid fa-star"></i></label>
            <input type="radio" id="star-4" name="review[rating]" value="4">
            <label for="star-4" data-value="4"><i class="fa-solid fa-star"></i></label>
            <input type="radio" id="star-5" name="review[rating]" value="5">
            <label for="star-5" data-value="5"><i class="fa-solid fa-star"></i></label>
          </div>
        </div>
        <div class="mb-3 mt-3">
          <label for="comment" class="form-label">Comments <span class="text-danger">*</span></label>
          <textarea name="review[comment]" id="comment" cols="30" rows="5" class="form-control" required placeholder="Please write your review comment..."></textarea>
        </div>
        <button type="submit" class="btn btn-outline-dark">Submit Review</button>
      </form>
    <% } else { %>
      <div class="alert alert-info d-flex justify-content-between align-items-center">
        <span>You must be logged in to leave a review.</span>
        <a href="/login" class="btn btn-sm btn-dark">Login</a>
      </div>
    <% } %>

    <hr/>

    <p><b>All Reviews</b></p>
    <div class="row g-3">
      <% for (let review of listing.reviews) { %>
        <div class="col-md-6 col-lg-4">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title"><%= review.author ? review.author.username : 'User' %></h5>
              <p class="card-text"><%= review.comment %></p>
              <p class="card-text" aria-label="Rating">
                <% for (let i = 1; i <= 5; i++) { %>
                  <% if (i <= Number(review.rating)) { %>
                    <i class="fa-solid fa-star" style="color:#ffb400"></i>
                  <% } else { %>
                    <i class="fa-regular fa-star" style="color:#ccc"></i>
                  <% } %>
                <% } %>
              </p>
            </div>
            <% if (currentUser && review.author && String(review.author._id) === String(currentUser._id)) { %>
              <div class="card-footer">
                <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                  <button class="btn btn-sm btn-dark">DELETE</button>
                </form>
              </div>
            <% } %>
          </div>
        </div>
      <% } %>
    </div>
  </div>
</div>





<script>
// Simple star rating interactivity: highlight filled stars up to the selected value
(function(){
  const container = document.getElementById('starRating');
  if (!container) return;
  const labels = Array.from(container.querySelectorAll('label'));
  const inputs = Array.from(container.querySelectorAll('input[type="radio"]'));

  function setFilled(value){
    labels.forEach(function(label){
      const v = Number(label.getAttribute('data-value'));
      if (v <= value) {
        label.classList.add('filled');
      } else {
        label.classList.remove('filled');
      }
    });
  }

  // Initialize with default checked
  const checked = container.querySelector('input[type="radio"]:checked');
  setFilled(checked ? Number(checked.value) : 3);

  labels.forEach(function(label){
    label.addEventListener('mouseenter', function(){
      setFilled(Number(label.getAttribute('data-value')));
    });
    label.addEventListener('click', function(){
      const val = Number(label.getAttribute('data-value'));
      const input = container.querySelector('input[value="' + val + '"]');
      if (input) input.checked = true;
      setFilled(val);
    });
  });

  container.addEventListener('mouseleave', function(){
    const c = container.querySelector('input[type="radio"]:checked');
    setFilled(c ? Number(c.value) : 0);
  });
})();
</script>
</div>
